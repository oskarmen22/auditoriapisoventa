<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Auditoría Inventario</title>
    
    <!-- 1. Librerías Necesarias -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Librería para Zoom y Pan -->
    <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
    <!-- Librería para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Estilos adicionales -->
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: sans-serif; background-color: #f8fafc; touch-action: none; height: 100dvh; min-height: -webkit-fill-available; }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .animate-scale-up { animation: scaleUp 0.2s ease-out; }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .resize-handle { width: 20px; height: 20px; background-color: #3b82f6; position: absolute; right: -10px; bottom: -10px; cursor: se-resize; border-radius: 50%; border: 3px solid white; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .rotate-handle { width: 20px; height: 20px; background-color: #22c55e; position: absolute; left: 50%; top: -25px; transform: translateX(-50%); cursor: grab; border-radius: 50%; border: 3px solid white; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .rotate-line { position: absolute; left: 50%; top: -25px; height: 25px; width: 2px; background-color: #22c55e; transform: translateX(-50%); pointer-events: none; }
        .group-resize-handle { width: 24px; height: 24px; background-color: #9333ea; position: absolute; right: -12px; bottom: -12px; cursor: se-resize; border-radius: 50%; border: 3px solid white; z-index: 50; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .interactive-zone { pointer-events: auto !important; touch-action: none; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        @keyframes pulse-red { 0%, 100% { border-color: rgba(239, 68, 68, 0.8); background-color: rgba(239, 68, 68, 0.2); transform: scale(1); } 50% { border-color: rgba(239, 68, 68, 1); background-color: rgba(239, 68, 68, 0.5); transform: scale(1.1); } }
        .highlight-zone { animation: pulse-red 1.5s infinite; z-index: 30 !important; }
        .transition-colors-fast { transition: background-color 0.3s ease, border-color 0.3s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONOS SVG ---
        const Icons = {
            Map: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            ClipboardList: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            RefreshCw: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Server: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Minus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Code: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            GroupSelect: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" strokeDasharray="4 4"/><path d="M9 9h6v6H9z"/></svg>,
            Bug: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>,
            Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        };

        // --- URL DEL SCRIPT DE GOOGLE ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMLTd-BD7CSH5zhN9iHZopYSwmIvSIiWCXn0sCHwt6ZLqipbLqRybM8ecDXBPRH4TC/exec"; 

        // --- ZONAS INICIALES ---
        const INITIAL_ZONES = [
  {
    "id": 1766548402904,
    "name": "ENTRADA (A-5)",
    "x": 444.89261323354367,
    "y": 1104.6820726018364,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766548421022,
    "name": "ENTRADA (A-3)",
    "x": 547.5217170778674,
    "y": 1102.968128609779,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766548427662,
    "name": "ENTRADA (A-1)",
    "x": 648.1346976528255,
    "y": 1104.809671143215,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766548435648,
    "name": "ENTRADA (A-6)",
    "x": 444.89400084708933,
    "y": 1203.8943998918642,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766548445396,
    "name": "ENTRADA (A-4)",
    "x": 544.3148898032066,
    "y": 1204.358158640711,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766548455674,
    "name": "ENTRADA (A-2)",
    "x": 648.0232223808124,
    "y": 1208.4548982569042,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766548496424,
    "name": "ENTRADA (B-1)",
    "x": 1109.474317377391,
    "y": 804.4071559633883,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 66.45
  },
  {
    "id": 1766548509372,
    "name": "ENTRADA (B-2)",
    "x": 1148.3077008468977,
    "y": 894.5373311988767,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 66.61
  },
  {
    "id": 1766548531211,
    "name": "ENTRADA (B-3)",
    "x": 1185.164008080786,
    "y": 984.3266305756822,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 64.93
  },
  {
    "id": 1766548552812,
    "name": "ENTRADA (B-4)",
    "x": 1223.3756738814195,
    "y": 1079.2841618248763,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 66.01
  },
  {
    "id": 1766548668091,
    "name": "RECIBA 1 (A-3)",
    "x": 1185.5308285297224,
    "y": 722.0363737361852,
    "w": 82.71067404365279,
    "h": 82.71067404365279,
    "r": 0
  },
  {
    "id": 1766548680572,
    "name": "RECIBA 1 (A-2)",
    "x": 1269.20132087384,
    "y": 720.5131337494229,
    "w": 82.71067404365279,
    "h": 82.71067404365279,
    "r": 0
  },
  {
    "id": 1766548691340,
    "name": "RECIBA 1 (A-1)",
    "x": 1345.77646121531,
    "y": 722.7503177282425,
    "w": 82.71067404365279,
    "h": 82.71067404365279,
    "r": 0
  },
  {
    "id": 1766552613704,
    "name": "RECIBA 1 (B-1)",
    "x": 1208.0920099290756,
    "y": 506.96172816232234,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552633782,
    "name": "RECIBA 1 (B-2)",
    "x": 1107.96045075453,
    "y": 506.52396459328,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552647339,
    "name": "RECIBA 1 (B-3)",
    "x": 1210.1242564678068,
    "y": 405.22283652235166,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552655184,
    "name": "RECIBA 1 (B-4)",
    "x": 1107.3142230240123,
    "y": 403.8397916249468,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552666874,
    "name": "RECIBA 1 (B-5)",
    "x": 1206.1581904829036,
    "y": 306.7422676446013,
    "w": 83.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552675409,
    "name": "RECIBA 1 (B-6)",
    "x": 1105.3320337697437,
    "y": 307.2913547170023,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552810676,
    "name": "RECIBA 1 (E. IZQUIERDA-1)",
    "x": 1234.4059294064755,
    "y": 218.0565410981261,
    "w": 103.38834255456598,
    "h": 77.54125691592448,
    "r": -44.35
  },
  {
    "id": 1766552851546,
    "name": "RECIBA 1 (E. IZQUIERDA-2)",
    "x": 1182.2465105876972,
    "y": 170.0326559815303,
    "w": 103.38834255456598,
    "h": 77.54125691592448,
    "r": -46.44
  },
  {
    "id": 1766552904868,
    "name": "RECIBA 1 (C-1)",
    "x": 1323.6105202194167,
    "y": 187.1049830406934,
    "w": 103.38834255456598,
    "h": 80.38834255456598,
    "r": 0
  },
  {
    "id": 1766552918732,
    "name": "RECIBA 1 (C-2)",
    "x": 1325.1211636582002,
    "y": 86.01703110796655,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552931604,
    "name": "RECIBA 1 (C-3)",
    "x": 1425.1591594855677,
    "y": 182.20033504334089,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552942018,
    "name": "RECIBA 1 (C-4)",
    "x": 1423.9506447345407,
    "y": 84.26746562444595,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552958418,
    "name": "RECIBA 1 (C-5)",
    "x": 1524.5394657002262,
    "y": 183.20033504334089,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552965808,
    "name": "RECIBA 1 (C-6)",
    "x": 1525.6348177028744,
    "y": 83.90734449142252,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552976176,
    "name": "RECIBA 1 (C-7)",
    "x": 1624.1282866659121,
    "y": 186.1049830406934,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552984430,
    "name": "RECIBA 1 (C-8)",
    "x": 1626.0409710031718,
    "y": 86.7941817430434,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766552992785,
    "name": "RECIBA 1 (C-9)",
    "x": 1727.045083404993,
    "y": 189.39103904863612,
    "w": 104.38834255456598,
    "h": 81.38834255456598,
    "r": 0
  },
  {
    "id": 1766553002034,
    "name": "RECIBA 1 (C-10)",
    "x": 1721.2357874102881,
    "y": 89.91538083132957,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553018687,
    "name": "RECIBA 1 (E. DERECHA-1)",
    "x": 1819.609795350958,
    "y": 219.2972012087809,
    "w": 103.38834255456598,
    "h": 77.54125691592448,
    "r": 45.02
  },
  {
    "id": 1766553040109,
    "name": "RECIBA 1 (E. DERECHA-2)",
    "x": 1871.6916729128206,
    "y": 163.85520251389482,
    "w": 103.38834255456598,
    "h": 77.54125691592448,
    "r": 45.75
  },
  {
    "id": 1766553151213,
    "name": "RECIBA 1 (D-1)",
    "x": 1874.1030581305654,
    "y": 304.97399182688804,
    "w": 75.38834255456598,
    "h": 102.38834255456598,
    "r": 0
  },
  {
    "id": 1766553159387,
    "name": "RECIBA 1 (D-2)",
    "x": 1949.4914006851313,
    "y": 300.97399182688804,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553169979,
    "name": "RECIBA 1 (D-3)",
    "x": 1844.2937621358606,
    "y": 399.76155313777593,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553179373,
    "name": "RECIBA 1 (D-4)",
    "x": 1946.0020441239144,
    "y": 403.45768638410146,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553196569,
    "name": "RECIBA 1 (D-5)",
    "x": 1895.496838786009,
    "y": 503.0465073497874,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553207725,
    "name": "RECIBA 1 (D-6)",
    "x": 1897.2802876950755,
    "y": 604.5480126527325,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553222062,
    "name": "RECIBA 1 (D-7)",
    "x": 1894.5921907886568,
    "y": 700.6474770572014,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553234687,
    "name": "RECIBA 1 (D-8)",
    "x": 1840.8835331288228,
    "y": 1001.6707233342789,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553241865,
    "name": "RECIBA 1 (D-9)",
    "x": 1843.0531020252056,
    "y": 1104.8442022742772,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553352547,
    "name": "PLANTA1 (A-1)",
    "x": 1693.4243232631097,
    "y": 1203.3732927287786,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553376037,
    "name": "PLANTA1 (A-2)",
    "x": 1793.426697599014,
    "y": 1203.3732927287786,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553383443,
    "name": "PLANTA1 (A-3)",
    "x": 1894.5921907886568,
    "y": 1199.883936167562,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553393197,
    "name": "PLANTA1 (A-4)",
    "x": 1995.7576839782992,
    "y": 1204.5364115825173,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553401867,
    "name": "PLANTA1 (A-5)",
    "x": 2094.571092374826,
    "y": 1202.21017387504,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553409445,
    "name": "PLANTA1 (A-6)",
    "x": 2198.062823271947,
    "y": 1202.21017387504,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553415764,
    "name": "PLANTA1 (A-7)",
    "x": 2293.412722192895,
    "y": 1201.0470550213008,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553422329,
    "name": "PLANTA1 (A-8)",
    "x": 2394.552368296899,
    "y": 1202.21017387504,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553430143,
    "name": "PLANTA1 (A-9)",
    "x": 2493.3916237790645,
    "y": 1202.21017387504,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553437254,
    "name": "PLANTA1 (A-10)",
    "x": 2596.883354676185,
    "y": 1204.5364115825173,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553446891,
    "name": "PLANTA1 (A-11)",
    "x": 2700.3750855733056,
    "y": 1196.3945796063456,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553457453,
    "name": "PLANTA1 (A-12)",
    "x": 2696.885729012089,
    "y": 1102.207799539136,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553517953,
    "name": "PLANTA2 (A-1)",
    "x": 2193.720512884655,
    "y": 1553.3428322759844,
    "w": 206.77668510913196,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553544397,
    "name": "PLANTA2 (A-2)",
    "x": 2193.074335743689,
    "y": 1652.1820877581495,
    "w": 206.77668510913196,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553593038,
    "name": "PLANTA2 (A-3)",
    "x": 2397.085382689486,
    "y": 1553.0843614195983,
    "w": 103.38834255456598,
    "h": 206.77668510913196,
    "r": 0
  },
  {
    "id": 1766553612405,
    "name": "PLANTA2 (A-4)",
    "x": 2494.2187305195007,
    "y": 1549.336534001995,
    "w": 103.38834255456598,
    "h": 206.77668510913196,
    "r": 0
  },
  {
    "id": 1766553628189,
    "name": "PLANTA2 (A-5)",
    "x": 2593.0579860016655,
    "y": 1551.6627717094732,
    "w": 103.38834255456598,
    "h": 206.77668510913196,
    "r": 0
  },
  {
    "id": 1766553642605,
    "name": "PLANTA2 (A-6)",
    "x": 2694.223479191309,
    "y": 1551.6627717094732,
    "w": 103.38834255456598,
    "h": 206.77668510913196,
    "r": 0
  },
  {
    "id": 1766553661739,
    "name": "PLANTA2 (A-7)",
    "x": 2795.388972380951,
    "y": 1553.9890094169505,
    "w": 103.38834255456598,
    "h": 206.77668510913196,
    "r": 0
  },
  {
    "id": 1766553741936,
    "name": "PLANTA2 (B-1)",
    "x": 2895.5205821450486,
    "y": 2203.7330482011207,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553763186,
    "name": "PLANTA2 (B-2)",
    "x": 2794.458477297961,
    "y": 2203.7330482011207,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553791686,
    "name": "PLANTA2 (C-1)",
    "x": 2593.3681510293295,
    "y": 2107.8662075673988,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553797674,
    "name": "PLANTA2 (C-2)",
    "x": 2594.531269883069,
    "y": 2208.4113707017145,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553805522,
    "name": "PLANTA2 (C-3)",
    "x": 2594.531269883069,
    "y": 2303.089245396058,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553812858,
    "name": "PLANTA2 (C-4)",
    "x": 2594.531269883069,
    "y": 2405.495398696356,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553825586,
    "name": "PLANTA2 (C-5)",
    "x": 2495.640320229626,
    "y": 2101.7662953566796,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553835900,
    "name": "PLANTA2 (C-7)",
    "x": 2496.3123444562307,
    "y": 2306.190895672695,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553866008,
    "name": "PLANTA2 (C-6)",
    "x": 2493.9861067487536,
    "y": 2203.7330482011207,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553873706,
    "name": "PLANTA2 (C-8)",
    "x": 2495.1492256024917,
    "y": 2403.6344085303735,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553883926,
    "name": "PLANTA2 (C-9)",
    "x": 2393.932038241572,
    "y": 2051.7263375602697,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553894068,
    "name": "PLANTA2 (C-10)",
    "x": 2392.5104485314464,
    "y": 2148.5236732769818,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553905454,
    "name": "PLANTA2 (C-11)",
    "x": 2391.088858821321,
    "y": 2249.327307267684,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553914450,
    "name": "PLANTA2 (C-12)",
    "x": 2395.7671813219154,
    "y": 2405.9864933234903,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553923116,
    "name": "PLANTA2 (C-13)",
    "x": 2292.8957804801216,
    "y": 2105.514122774283,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553930478,
    "name": "PLANTA2 (C-14)",
    "x": 2293.8262755631135,
    "y": 2206.498686364455,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553944531,
    "name": "PLANTA2 (C-15)",
    "x": 2294.3173701902483,
    "y": 2305.6739539599225,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766553954844,
    "name": "PLANTA2 (C-16)",
    "x": 2292.8957804801216,
    "y": 2403.6344085303735,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766554042122,
    "name": "DE CARGA (A-1)",
    "x": 946.2402477530968,
    "y": 1702.4029751540302,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766554052179,
    "name": "DE CARGA (A-2)",
    "x": 946.2402477530968,
    "y": 1607.6217121171314,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766554061360,
    "name": "DE CARGA (A-3)",
    "x": 944.117310598893,
    "y": 1503.7164278497926,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  },
  {
    "id": 1766554072806,
    "name": "DE CARGA (A-4)",
    "x": 946.2402477530968,
    "y": 1405.0581019670985,
    "w": 103.38834255456598,
    "h": 103.38834255456598,
    "r": 0
  }
];

        // --- COMPONENTE DE CONSOLA DE DEBUG ---
        const DebugConsole = ({ logs }) => {
            if (!logs || logs.length === 0) return null;
            return (
                <div className="fixed bottom-20 left-4 z-50 pointer-events-none opacity-80">
                    <div className="bg-black/80 text-green-400 p-2 rounded text-[10px] font-mono w-64 max-h-32 overflow-hidden flex flex-col-reverse shadow-lg border border-green-900">
                        {logs.slice(-5).map((log, i) => (
                            <div key={i}>{log}</div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- COMPONENTES DE UI GENÉRICOS ---

        const Modal = ({ isOpen, onClose, title, children, zIndex = 100, align = 'center' }) => {
            if (!isOpen) return null;
            const alignmentClass = align === 'top' ? 'items-start pt-12' : 'items-center';

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 flex ${alignmentClass} justify-center p-4 animate-fade-in`} style={{zIndex: zIndex}}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden animate-scale-up">
                        <div className="bg-blue-900 p-4 flex justify-between items-center text-white">
                            <h3 className="font-bold text-lg">{title}</h3>
                            {onClose && <button onClick={onClose} className="hover:bg-blue-800 p-1 rounded"><Icons.X /></button>}
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const AutocompleteInput = ({ items, value, onChange, placeholder, onSelect, onEnter }) => {
            const [suggestions, setSuggestions] = React.useState([]);
            const [showSuggestions, setShowSuggestions] = React.useState(false);

            const handleChange = (e) => {
                const inputVal = e.target.value;
                onChange(inputVal);
                if (inputVal.length > 0) {
                    const filtered = items.filter(item => String(item).toLowerCase().includes(inputVal.toLowerCase()));
                    setSuggestions(filtered);
                    setShowSuggestions(true);
                } else {
                    setShowSuggestions(false);
                }
            };

            const handleSelect = (item) => {
                const val = String(item);
                onChange(val);
                setShowSuggestions(false);
                if (onSelect) onSelect(val);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (onEnter) onEnter();
                    setShowSuggestions(false);
                }
            };

            return (
                <div className="relative w-full">
                    <input 
                        type="text" 
                        className="w-full p-3 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none" 
                        placeholder={placeholder} 
                        value={value} 
                        onChange={handleChange} 
                        onFocus={() => value && handleChange({target: {value}})} 
                        onKeyDown={handleKeyDown}
                    />
                    {showSuggestions && suggestions.length > 0 && (
                        <ul className="absolute z-50 w-full bg-white border border-slate-200 rounded-lg mt-1 max-h-48 overflow-y-auto shadow-xl">
                            {suggestions.map((item, idx) => (
                                <li key={idx} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm text-slate-700" onClick={() => handleSelect(item)}>{String(item)}</li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        // --- COMPONENTE DE CAJA INTERACTIVA (ZONA) ---
        const InteractiveZone = ({ zone, isEditMode, onUpdate, onClick, isAudited, onDelete, isDebugMode, addLog, isHighlighted, isPending, isDeleting }) => {
            const boxRef = React.useRef(null);
            const [isDragging, setIsDragging] = React.useState(false);
            const [dragOffset, setDragOffset] = React.useState({ x: 0, y: 0 });
            
            // COLORES
            const getColors = () => {
                if (isEditMode) return { bg: 'rgba(59, 130, 246, 0.3)', border: 'rgba(59, 130, 246, 0.8)' };
                if (isDeleting) return { bg: 'rgba(239, 68, 68, 0.6)', border: 'rgba(220, 38, 38, 0.9)' }; // ROJO (Eliminando)
                if (isPending) return { bg: 'rgba(59, 130, 246, 0.6)', border: 'rgba(37, 99, 235, 0.9)' }; // AZUL (En Cola)
                if (isAudited) return { bg: 'rgba(34, 197, 94, 0.6)', border: 'rgba(22, 163, 74, 0.9)' }; // VERDE (Guardado)
                // En modo debug o normal, aseguramos visibilidad mínima para que el usuario sepa dónde tocar
                return { bg: 'rgba(255, 255, 255, 0.05)', border: isDebugMode ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 0, 255, 0.1)' }; 
            };
            const colors = getColors();

            const startDrag = (e) => {
                if (!isEditMode) return;
                e.stopPropagation(); 
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                setIsDragging(true);
                setDragOffset({ x: clientX - zone.x, y: clientY - zone.y });
            };

            const startResize = (e) => {
                if (!isEditMode) return;
                e.stopPropagation();
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const startWidth = zone.w;
                const startHeight = zone.h;
                const onMove = (moveEvent) => {
                    const currentX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const currentY = moveEvent.touches ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    onUpdate(zone.id, { w: Math.max(10, startWidth + (currentX - startX)), h: Math.max(10, startHeight + (currentY - startY)) });
                };
                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };

            const startRotate = (e) => {
                if (!isEditMode) return;
                e.stopPropagation();
                e.preventDefault();
                const boxRect = boxRef.current.getBoundingClientRect();
                const centerX = boxRect.left + boxRect.width / 2;
                const centerY = boxRect.top + boxRect.height / 2;
                const onMove = (moveEvent) => {
                    const currentX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const currentY = moveEvent.touches ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    const angleRad = Math.atan2(currentY - centerY, currentX - centerX);
                    onUpdate(zone.id, { r: (angleRad * (180 / Math.PI)) + 90 });
                };
                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };

            React.useEffect(() => {
                if (!isDragging) return;
                const onMove = (e) => {
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    onUpdate(zone.id, { x: clientX - dragOffset.x, y: clientY - dragOffset.y });
                };
                const onEnd = () => setIsDragging(false);
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onEnd);
                return () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };
            }, [isDragging, dragOffset, onUpdate, zone.id]);

            // --- MANEJADORES DE TOQUE NATIVOS (SOLUCIÓN DEFINITIVA) ---
            React.useEffect(() => {
                const element = boxRef.current;
                if (!element || isEditMode) return;

                let startX = 0;
                let startY = 0;
                let startTime = 0;
                let isDrag = false;

                const onTouchStart = (e) => {
                    if (e.touches.length > 1) return; // Ignorar zoom multitouch
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                    isDrag = false;
                    // NO detenemos propagación aquí para permitir que el mapa reciba el evento y decida si hacer scroll
                };

                const onTouchMove = (e) => {
                    const x = e.touches[0].clientX;
                    const y = e.touches[0].clientY;
                    // Si se mueve más de 15px, asumimos que es un arrastre de mapa, no un clic
                    if (Math.abs(x - startX) > 15 || Math.abs(y - startY) > 15) {
                        isDrag = true;
                    }
                };

                const onTouchEnd = (e) => {
                    const timeDiff = Date.now() - startTime;
                    // Si no fue un arrastre largo y el toque fue rápido (<500ms)
                    if (!isDrag && timeDiff < 500) {
                        // Es un TAP válido
                        if(e.cancelable) e.preventDefault(); // Prevenir comportamientos del navegador
                        e.stopPropagation(); // Detener para que el mapa no intente hacer nada más
                        
                        if (isDebugMode) addLog(`NATIVE TAP: ${zone.name}`);
                        onClick(zone.name);
                    }
                };

                // Añadimos listeners nativos NO pasivos para poder llamar preventDefault si es necesario
                element.addEventListener('touchstart', onTouchStart, { passive: true });
                element.addEventListener('touchmove', onTouchMove, { passive: true });
                element.addEventListener('touchend', onTouchEnd, { passive: false });

                return () => {
                    element.removeEventListener('touchstart', onTouchStart);
                    element.removeEventListener('touchmove', onTouchMove);
                    element.removeEventListener('touchend', onTouchEnd);
                };
            }, [isEditMode, onClick, zone.name, isDebugMode, addLog]);

            return (
                <div ref={boxRef} 
                    className={`interactive-zone transition-colors-fast ${isHighlighted ? 'highlight-zone' : ''}`}
                    onMouseDown={startDrag} 
                    onClick={(e) => { 
                        // Clic para escritorio (mouse)
                        e.stopPropagation(); 
                        if(!isEditMode) {
                            if(isDebugMode) addLog(`Mouse Click: ${zone.name}`);
                            onClick(zone.name); 
                        }
                    }}
                    style={{ 
                        position: 'absolute', 
                        left: zone.x, 
                        top: zone.y, 
                        width: zone.w, 
                        height: zone.h, 
                        transform: `rotate(${zone.r || 0}deg)`, 
                        transformOrigin: 'center center', 
                        border: isHighlighted ? '3px solid red' : `2px solid ${colors.border}`, 
                        backgroundColor: isHighlighted ? 'rgba(255,0,0,0.3)' : colors.bg, 
                        cursor: isEditMode ? 'move' : 'pointer', 
                        zIndex: isHighlighted ? 30 : 10, 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'center', 
                        boxSizing: 'border-box' 
                    }}
                >
                    <span className={`px-1 text-[8px] font-bold pointer-events-none select-none truncate max-w-full ${isEditMode ? 'bg-white/80' : 'hidden'}`}>{zone.name}</span>
                    {isEditMode && (
                        <>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(zone.id); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md z-30" style={{width: '12px', height: '12px', fontSize: '8px', lineHeight: '10px'}}>✕</button>
                            <div className="resize-handle" onMouseDown={startResize} onTouchStart={startResize} />
                            <div className="rotate-line"></div>
                            <div className="rotate-handle" onMouseDown={startRotate} onTouchStart={startRotate} />
                        </>
                    )}
                </div>
            );
        };

        const MapEditor = ({ onLocationClick, auditedLocations, locationsList, isDebugMode, addLog, auditLog, focusTarget, pendingLocations, deletingLocations }) => {
            const mapImageUrl = "https://i.imgur.com/VRncOKx.jpeg";
            const [zones, setZones] = React.useState(INITIAL_ZONES);
            const [isEditMode, setIsEditMode] = React.useState(false); 
            const [isPlacingMode, setIsPlacingMode] = React.useState(false);
            const [isAddZoneModalOpen, setIsAddZoneModalOpen] = React.useState(false);
            const [newZoneName, setNewZoneName] = React.useState("");
            const [newZoneW, setNewZoneW] = React.useState(40);
            const [newZoneH, setNewZoneH] = React.useState(40);
            const [tempClickCoords, setTempClickCoords] = React.useState({x:0, y:0});
            const [isCopyModalOpen, setIsCopyModalOpen] = React.useState(false);
            const [zonesJson, setZonesJson] = React.useState("");
            const [isGlobalEditMode, setIsGlobalEditMode] = React.useState(false);
            const mapContainerRef = React.useRef(null);
            const panzoomInstance = React.useRef(null);
            const imageRef = React.useRef(null);

            // --- ESTADOS PARA BÚSQUEDA AVANZADA EN MAPA ---
            const [isSearchModalOpen, setIsSearchModalOpen] = React.useState(false);
            const [searchType, setSearchType] = React.useState('product'); // Default to product as requested
            const [mapSearchQuery, setMapSearchQuery] = React.useState('');
            const [highlightedZones, setHighlightedZones] = React.useState([]);

            // Función para centrar en una zona
            const centerOnZone = (zoneName) => {
                 if (panzoomInstance.current && mapContainerRef.current) {
                    const targetZone = zones.find(z => z.name === zoneName);
                    if (targetZone) {
                        const rect = mapContainerRef.current.getBoundingClientRect();
                        const parent = mapContainerRef.current.parentElement.getBoundingClientRect();
                        
                        // Center of the viewport
                        const containerCenterX = parent.width / 2;
                        const containerCenterY = parent.height / 2;
                        
                        // Current scale
                        const scale = panzoomInstance.current.getTransform().scale;
                        
                        // Zone center relative to the map image
                        const zoneCenterX = targetZone.x + targetZone.w / 2;
                        const zoneCenterY = targetZone.y + targetZone.h / 2;
                        
                        // Calculate transform needed
                        const newX = containerCenterX - zoneCenterX * scale;
                        const newY = containerCenterY - zoneCenterY * scale;

                        panzoomInstance.current.moveTo(newX, newY);
                    }
                }
            };

            // Manejar foco externo (desde lista/historial)
            React.useEffect(() => {
                if (focusTarget) {
                    setHighlightedZones([focusTarget.location]);
                    centerOnZone(focusTarget.location);
                }
            }, [focusTarget, zones]);

            // Identificar zonas resaltadas (búsqueda interna del mapa)
            React.useEffect(() => {
                if (highlightedZones.length > 0) {
                    centerOnZone(highlightedZones[0]);
                }
            }, [highlightedZones]);

            // Inicialización de Panzoom y centrado inicial (FIT TO SCREEN RESTAURADO)
            const handleImageLoad = () => {
                 if (mapContainerRef.current && panzoomInstance.current) {
                    // Esperar un momento para asegurar renderizado correcto
                    setTimeout(() => {
                        const img = imageRef.current;
                        if (!img) return;

                        const parent = mapContainerRef.current.parentElement;
                        if (!parent) return;

                        const parentRect = parent.getBoundingClientRect();
                        // Usamos dimensions naturales o si la imagen tiene width/height definido en CSS
                        const contentWidth = img.naturalWidth || img.width; 
                        const contentHeight = img.naturalHeight || img.height;

                        if (contentWidth === 0 || contentHeight === 0) return;

                        // Calculate scale to fit width or height (Fit-to-Screen Logic)
                        const scaleX = parentRect.width / contentWidth;
                        const scaleY = parentRect.height / contentHeight;
                        
                        // Usar escala menor para asegurar fit, con margen 5%
                        const initialScale = Math.min(scaleX, scaleY) * 0.95; 

                        // Center logic
                        const initialX = (parentRect.width - contentWidth * initialScale) / 2;
                        const initialY = (parentRect.height - contentHeight * initialScale) / 2;

                        // Apply transform manually first time to ensure correct positioning
                        panzoomInstance.current.zoomAbs(0, 0, initialScale);
                        panzoomInstance.current.moveTo(initialX, initialY);

                    }, 100);
                }
            }

            React.useEffect(() => {
                if (mapContainerRef.current) {
                    panzoomInstance.current = panzoom(mapContainerRef.current, { 
                        maxZoom: 10, 
                        minZoom: 0.1, 
                        initialZoom: 1,
                        bounds: false, // Permitir mover libremente para centrar bien
                        //boundsPadding: 0.1,
                        filterKey: function() { return true; }, 
                        onTouch: function(e) { return true; } 
                    });
                }
                return () => panzoomInstance.current && panzoomInstance.current.dispose();
            }, []);

            React.useEffect(() => { if(panzoomInstance.current) (isEditMode || isGlobalEditMode) ? panzoomInstance.current.pause() : panzoomInstance.current.resume(); }, [isEditMode, isGlobalEditMode]);

            const startPlacement = () => setIsPlacingMode(true);

            const handlePlaneClick = (e) => {
                if (!isPlacingMode) return;
                const rect = mapContainerRef.current.getBoundingClientRect();
                const scale = panzoomInstance.current.getTransform().scale;
                const x = (e.clientX - rect.left) / scale;
                const y = (e.clientY - rect.top) / scale;
                setTempClickCoords({x, y});
                setIsPlacingMode(false);
                setNewZoneName(""); setNewZoneW(40); setNewZoneH(40);
                setIsAddZoneModalOpen(true);
            };

            const confirmAddZone = () => {
                if (!newZoneName.trim()) return;
                const newZone = { id: Date.now(), name: newZoneName, x: tempClickCoords.x - (newZoneW/2), y: tempClickCoords.y - (newZoneH/2), w: parseInt(newZoneW), h: parseInt(newZoneH), r: 0 };
                setZones([...zones, newZone]);
                setIsAddZoneModalOpen(false);
            };

            const updateZone = (id, newProps) => setZones(zones.map(z => z.id === id ? { ...z, ...newProps } : z));
            const deleteZone = (id) => { if(confirm("¿Borrar esta zona?")) setZones(zones.filter(z => z.id !== id)); };

            const startGlobalDrag = (e) => {
                e.stopPropagation();
                e.preventDefault();
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const initialZones = zones.map(z => ({...z}));
                const onMove = (moveEvent) => {
                    const currentX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const currentY = moveEvent.touches ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    const scale = panzoomInstance.current.getTransform().scale;
                    const dx = (currentX - startX) / scale;
                    const dy = (currentY - startY) / scale;
                    setZones(initialZones.map(z => ({...z, x: z.x + dx, y: z.y + dy})));
                };
                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };

            const startGlobalResize = (e) => {
                e.stopPropagation();
                e.preventDefault();
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const xValues = zones.map(z => z.x);
                const minY = Math.min(...zones.map(z => z.y));
                const minX = Math.min(...xValues);
                const maxX = Math.max(...xValues.map((v, i) => v + zones[i].w));
                const initialWidth = maxX - minX;
                const initialZones = zones.map(z => ({...z}));
                const onMove = (moveEvent) => {
                    const currentX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const scale = panzoomInstance.current.getTransform().scale;
                    const diffX = (currentX - startX) / scale;
                    const scaleFactor = (initialWidth + diffX) / initialWidth;
                    if(scaleFactor > 0.1) {
                        setZones(initialZones.map(z => ({
                            ...z,
                            x: minX + (z.x - minX) * scaleFactor,
                            y: minY + (z.y - minY) * scaleFactor,
                            w: z.w * scaleFactor,
                            h: z.h * scaleFactor
                        })));
                    }
                };
                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };

            const getGroupBounds = () => {
                if (zones.length === 0) return { x: 0, y: 0, w: 0, h: 0 };
                const minX = Math.min(...zones.map(z => z.x));
                const minY = Math.min(...zones.map(z => z.y));
                const maxX = Math.max(...zones.map(z => z.x + z.w));
                const maxY = Math.max(...zones.map(z => z.y + z.h));
                return { x: minX, y: minY, w: maxX - minX, h: maxY - minY };
            };
            const groupBounds = getGroupBounds();

            const exportZones = () => {
                const json = JSON.stringify(zones, null, 2);
                setZonesJson(json);
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = json; textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                    document.body.appendChild(textArea); textArea.select();
                    const successful = document.execCommand('copy'); document.body.removeChild(textArea);
                    if (successful) return alert("¡Copiado! Pégalo en INITIAL_ZONES.");
                } catch (err) {}
                setIsCopyModalOpen(true);
            };
            
            // --- Lógica del Modal de Búsqueda ---
            const handleSearchSubmit = (val) => {
                setMapSearchQuery(val);
                setIsSearchModalOpen(false);
                
                // Siempre buscar producto (punto 2: quitar búsqueda de lugar, ir directo a producto)
                // Buscar todas las zonas que tengan ese producto
                const zonesWithProduct = auditLog
                    .filter(entry => entry.product === val)
                    .map(entry => entry.location);
                
                if (zonesWithProduct.length > 0) {
                    setHighlightedZones(zonesWithProduct);
                } else {
                    alert("Este producto no está en ninguna ubicación auditada.");
                    setHighlightedZones([]);
                }
                setMapSearchQuery('');
            };

            const uniqueProducts = React.useMemo(() => [...new Set(auditLog.map(item => item.product))].sort(), [auditLog]);

            // Handler para abrir búsqueda directa
            const openSearch = () => {
                setSearchType('product'); // Forzar tipo producto
                setIsSearchModalOpen(true);
            };


            return (
                <div className="flex flex-col h-full bg-slate-200 relative overflow-hidden">
                    <div className={`absolute top-4 left-4 right-4 z-20 flex gap-2 justify-between pointer-events-none ${isEditMode ? '' : 'hidden'}`}>
                        <div className="flex gap-2 pointer-events-auto">
                            <button onClick={() => setIsEditMode(!isEditMode)} className={`p-3 rounded-full shadow-lg font-bold flex items-center gap-2 transition-colors ${isEditMode ? 'bg-orange-500 text-white' : 'bg-white text-slate-700'}`}>
                                {isEditMode ? <Icons.Unlock /> : <Icons.Lock />} {isEditMode ? 'Editando' : 'Navegando'}
                            </button>
                            {isEditMode && (
                                <button 
                                    onClick={() => setIsGlobalEditMode(!isGlobalEditMode)} 
                                    className={`p-3 rounded-full shadow-lg font-bold flex items-center gap-2 transition-colors ${isGlobalEditMode ? 'bg-purple-600 text-white' : 'bg-white text-purple-700'}`}
                                    title="Mover/Escalar Todos"
                                >
                                    <Icons.GroupSelect />
                                </button>
                            )}
                        </div>
                        {isEditMode && (
                            <div className="flex gap-2 pointer-events-auto">
                                <button onClick={startPlacement} className={`p-3 rounded-full shadow-lg hover:bg-blue-700 flex items-center gap-1 text-white ${isPlacingMode ? 'bg-green-600 animate-pulse' : 'bg-blue-600'}`}>
                                    <Icons.Plus /> {isPlacingMode ? 'Toca mapa' : 'Zona'}
                                </button>
                                <button onClick={exportZones} className="bg-slate-800 text-white p-3 rounded-full shadow-lg hover:bg-black"><Icons.Save /></button>
                            </div>
                        )}
                    </div>
                    {isPlacingMode && <div className="absolute top-20 left-0 right-0 flex justify-center z-30 pointer-events-none"><div className="bg-black/70 text-white px-4 py-2 rounded-full text-sm font-bold shadow-xl">Toca en el mapa donde quieras el botón</div></div>}
                    
                    <div className="absolute inset-0 bg-slate-100 overflow-hidden active:cursor-grabbing prevent-browser-zoom">
                        <div ref={mapContainerRef} onClick={handlePlaneClick} className="relative shadow-2xl bg-white" style={{ width: 'max-content', height: 'max-content', transformOrigin: '0 0' }}>
                            <img 
                                ref={imageRef}
                                src={mapImageUrl} 
                                alt="Plano" 
                                className="pointer-events-none select-none block" 
                                draggable="false" 
                                style={{ maxWidth: 'none', display: 'block' }} 
                                onLoad={handleImageLoad}
                            />
                            
                            {isGlobalEditMode && isEditMode && (
                                <div 
                                    onMouseDown={startGlobalDrag}
                                    onTouchStart={startGlobalDrag}
                                    style={{
                                        position: 'absolute', left: groupBounds.x, top: groupBounds.y, width: groupBounds.w, height: groupBounds.h,
                                        border: '2px dashed #9333ea', backgroundColor: 'rgba(147, 51, 234, 0.1)', zIndex: 40, cursor: 'move'
                                    }}
                                >
                                    <div className="group-resize-handle" onMouseDown={startGlobalResize} onTouchStart={startGlobalResize} />
                                </div>
                            )}

                            {zones.map(zone => <InteractiveZone key={zone.id} zone={zone} isEditMode={isEditMode} onUpdate={updateZone} onClick={onLocationClick} isAudited={auditedLocations.includes(zone.name)} onDelete={deleteZone} isDebugMode={isDebugMode} addLog={addLog} isHighlighted={highlightedZones.includes(zone.name)} isPending={pendingLocations.includes(zone.name)} isDeleting={deletingLocations.includes(zone.name)} />)}
                        </div>
                    </div>
                    
                    {/* Botón Flotante de Búsqueda */}
                    <div className="absolute bottom-6 right-6 z-30 pointer-events-auto flex flex-col gap-2 items-end">
                         {highlightedZones.length > 0 && (
                            <button 
                                onClick={() => setHighlightedZones([])} 
                                className="bg-white text-red-500 font-bold p-3 rounded-full shadow-lg hover:bg-red-50"
                                title="Limpiar Búsqueda"
                            >
                                <Icons.X />
                            </button>
                        )}
                        <button 
                            onClick={openSearch} 
                            className="bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 transition-transform active:scale-95"
                            title="Buscar en Mapa"
                        >
                            <Icons.Search />
                        </button>
                    </div>

                    {/* MODAL DE BÚSQUEDA FLOTANTE */}
                    {isSearchModalOpen && (
                        <div className="absolute inset-0 bg-black/50 z-50 flex items-start pt-12 justify-center p-4 animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm animate-scale-up">
                                <div className="bg-gradient-to-r from-blue-600 to-blue-800 p-4 flex justify-between items-center text-white">
                                    <h3 className="font-bold text-lg flex items-center gap-2">
                                        Buscar Producto
                                    </h3>
                                    <button onClick={() => { setIsSearchModalOpen(false); }} className="hover:bg-white/20 p-1 rounded"><Icons.X /></button>
                                </div>
                                <div className="p-6">
                                    <div className="space-y-4">
                                        <p className="text-sm text-slate-500 mb-2">
                                            Busca entre los productos registrados en el historial.
                                        </p>
                                        <div className="flex gap-2">
                                            <div className="flex-1 relative">
                                                <AutocompleteInput 
                                                    items={uniqueProducts} 
                                                    value={mapSearchQuery} 
                                                    onChange={setMapSearchQuery} 
                                                    onSelect={handleSearchSubmit} 
                                                    placeholder="Ej: Maíz Blanco..." 
                                                />
                                            </div>
                                            <button onClick={() => handleSearchSubmit(mapSearchQuery)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">Ir</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <Modal isOpen={isAddZoneModalOpen} onClose={() => setIsAddZoneModalOpen(false)} title="Configurar Botón" align="top">
                        <div className="space-y-4">
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Ubicación</label><AutocompleteInput items={locationsList} value={newZoneName} onChange={setNewZoneName} placeholder="Ej: A-1" /></div>
                            <div className="flex gap-4">
                                <div className="flex-1"><label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label><input type="number" className="w-full p-2 border rounded" value={newZoneW} onChange={(e) => setNewZoneW(e.target.value)} /></div>
                                <div className="flex-1"><label className="block text-xs font-bold text-slate-500 mb-1">Alto</label><input type="number" className="w-full p-2 border rounded" value={newZoneH} onChange={(e) => setNewZoneH(e.target.value)} /></div>
                            </div>
                            <button onClick={confirmAddZone} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-2">Crear</button>
                        </div>
                    </Modal>
                    <Modal isOpen={isCopyModalOpen} onClose={() => setIsCopyModalOpen(false)} title="Guardar Cambios">
                        <div className="space-y-2"><p className="text-xs text-slate-500">Copia esto y pégalo en <code>INITIAL_ZONES</code>:</p><textarea className="w-full h-40 p-2 text-xs font-mono border rounded bg-slate-50" readOnly value={zonesJson} onClick={(e) => e.target.select()} /><button onClick={() => setIsCopyModalOpen(false)} className="w-full bg-slate-700 text-white py-2 rounded text-sm">Cerrar</button></div>
                    </Modal>
                </div>
            );
        };

        const InventoryAuditApp = () => {
            const [activeTab, setActiveTab] = React.useState('map');
            const [products, setProducts] = React.useState([]);
            const [locations, setLocations] = React.useState([]);
            const [auditLog, setAuditLog] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [lastUpdate, setLastUpdate] = React.useState(null);
            const [isOnline, setIsOnline] = React.useState(false);
            
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [selectedLocation, setSelectedLocation] = React.useState('');
            const [selectedProduct, setSelectedProduct] = React.useState('');
            const [quantity, setQuantity] = React.useState('');
            const [isSaving, setIsSaving] = React.useState(false);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [historySearchTerm, setHistorySearchTerm] = React.useState('');
            const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = React.useState(false);
            
            const quantityInputRef = React.useRef(null);
            
            // --- MODO DEBUG Y HERRAMIENTAS ---
            const [showTools, setShowTools] = React.useState(false);
            const [isDebugMode, setIsDebugMode] = React.useState(false);
            const [logs, setLogs] = React.useState([]);
            
            // --- COLA DE GUARDADO Y FOCO ---
            const [saveQueue, setSaveQueue] = React.useState([]); // Cola de objetos payload
            const [focusTarget, setFocusTarget] = React.useState(null); // {location: 'A-1', timestamp: 123}
            const [pendingVerification, setPendingVerification] = React.useState([]);
            const [deletingLocations, setDeletingLocations] = React.useState([]); // Zonas en proceso de borrado

            const addLog = (msg) => setLogs(prev => [...prev, `${new Date().toLocaleTimeString().split(' ')[0]} - ${msg}`]);

            const fetchSheetData = async (silent = false) => {
                if (!APPS_SCRIPT_URL) return;
                if (!silent) setLoading(true);
                try {
                    // console.log("Intentando conectar..."); // Debug connection
                    
                    // CAMBIO IMPORTANTE: Added credentials: 'omit' para evitar conflictos CORS con cookies de Google
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'GET',
                        credentials: 'omit',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const text = await response.text(); // Get raw text first
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        // console.error("Error parseando JSON:", text); // Log raw response if parse fails
                        throw new Error("Respuesta no válida (HTML en vez de JSON)");
                    }

                    if (data.status === 'success') {
                        setProducts((data.products || []).filter(p => p && String(p).trim() !== ""));
                        setLocations((data.locations || []).filter(l => l && String(l).trim() !== ""));
                        const newLog = (data.auditLog || []).reverse();
                        setAuditLog(newLog);
                        setPendingVerification(prev => prev.filter(loc => !newLog.some(entry => entry.location === loc)));
                        setDeletingLocations(prev => prev.filter(loc => newLog.some(entry => entry.location === loc)));
                        setLastUpdate(new Date());
                        setIsOnline(true);
                        setError(''); // Clear error on success
                    } else {
                        setIsOnline(false);
                        setError('Error en status del servidor');
                    }
                } catch (err) { 
                    // console.error("Error de conexión:", err); // Log visible
                    setIsOnline(false);
                    setError(err.message); // Store error for UI
                } finally { 
                    if (!silent) setLoading(false); 
                }
            };
            
            // PROCESADOR DE COLA DE GUARDADO
            React.useEffect(() => {
                const processQueue = async () => {
                    if (saveQueue.length === 0) return;

                    const itemToSave = saveQueue[0]; // Tomar el primero
                    
                    try {
                        // Enviar sin await blocking UI, pero await aqui para la cola serial
                        // CAMBIO: También aquí aseguramos 'no-cors' si es necesario, pero POST usually requires headers
                        // Para POST a Apps Script Web App, 'no-cors' funciona pero no devuelve respuesta legible.
                        // Usamos standard fetch, confiando en que el GET funcionó.
                        await fetch(APPS_SCRIPT_URL, { 
                            method: 'POST', 
                            body: JSON.stringify(itemToSave),
                            credentials: 'omit' // Added consistency
                        });
                        // Exito, quitar de la cola
                        setSaveQueue(prev => prev.slice(1));
                        addLog(`Cola procesada: ${itemToSave.location} guardado.`);
                    } catch (err) {
                        addLog(`Error guardando cola: ${itemToSave.location}`);
                        // Opcional: Reintentar o quitar. Por ahora quitamos para no atascar.
                         setSaveQueue(prev => prev.slice(1));
                    }
                };
                
                // Ejecutar procesador si hay items
                if (saveQueue.length > 0) {
                    processQueue();
                }
            }, [saveQueue]);

            // Efecto para Ctrl+D
            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        setShowTools(prev => !prev);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            // Polling cada 3 segundos (ACTUALIZADO)
            React.useEffect(() => { 
                fetchSheetData(); 
                const interval = setInterval(() => fetchSheetData(true), 3000); // 3000ms = 3 segundos
                return () => clearInterval(interval);
            }, []);
            
            // Función de formateo de fecha segura (ACTUALIZADA + DEBUG)
            const formatDate = (val) => {
                if (!val) return '-';
                
                // Si el valor es texto y ya parece una fecha (tiene / o : y no es formato ISO 'T'),
                // lo devolvemos TAL CUAL viene de la base de datos.
                if (typeof val === 'string' && (val.includes('/') || val.includes(':')) && !val.includes('T')) {
                    return val;
                }

                let dateObj = null;

                // Caso 1: String con formato DD/MM/YYYY o DD-MM-YYYY (o ISO con T)
                if (typeof val === 'string') {
                    const cleanVal = val.replace(/['"]/g, '');
                    if (cleanVal.includes('T') || cleanVal.match(/^\d{4}-\d{2}-\d{2}/)) {
                        dateObj = new Date(cleanVal);
                    } else if (cleanVal.includes('/')) {
                        const parts = cleanVal.split(/[\/\s:]/); // Separar por / espacio :
                        if (parts.length >= 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1; // Mes 0-11
                            let year = parseInt(parts[2], 10);
                            if (year < 100) year += 2000; // Asumir 20xx
                            
                            let hours = 0, minutes = 0, seconds = 0;
                            if (parts.length >= 5) {
                                hours = parseInt(parts[3], 10);
                                minutes = parseInt(parts[4], 10);
                                if (parts[5]) seconds = parseInt(parts[5], 10);
                            }
                            dateObj = new Date(year, month, day, hours, minutes, seconds);
                        }
                    } else {
                        // Si es texto pero no parece fecha standard, lo retornamos tal cual (ej: "Ayer")
                        return val;
                    }
                }
                
                // Caso 2: Timestamp numérico (ID o timestamp real)
                if (!dateObj && !isNaN(Number(val))) {
                    const num = Number(val);
                    // Solo tratamos como fecha si el número es GRANDE (un timestamp real en milisegundos)
                    // 1000000000000 equivale al año 2001. Si es menor (ej. id: 55), NO es una fecha.
                    if (num > 1000000000000) {
                        dateObj = new Date(num);
                    } else {
                        return "-"; 
                    }
                }
                
                // Fallback final: Si es texto y Date() lo entiende
                if (!dateObj && typeof val === 'string') {
                    const tryDate = new Date(val);
                    if (!isNaN(tryDate.getTime())) {
                        dateObj = tryDate;
                    }
                }
                
                // Si después de todo no es fecha válida, devolvemos el valor original (o un guion)
                if (!dateObj || isNaN(dateObj.getTime())) return val;

                // Formatear a dd/mm/yyyy hh:mm:ss
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = String(dateObj.getFullYear()); 
                const hours = String(dateObj.getHours()).padStart(2, '0');
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                const seconds = String(dateObj.getSeconds()).padStart(2, '0');

                return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
            }

            // Función para generar PDF
            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("Reporte de Auditoría", 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Fecha: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 14, 30);
                
                // CAMBIO: Nombre de columna actualizado
                const tableColumn = ["Lugar", "Producto", "Cantidad", "FECHA REGISTRO"];
                const tableRows = [];

                // Usamos auditLog clonado y ORDENADO CRONOLÓGICAMENTE para el PDF
                // El estado auditLog está en orden inverso (Reciente->Antiguo) para UI
                // Pero el PDF debe ser cronológico (Antiguo->Reciente)
                const chronologicalLog = [...auditLog].sort((a, b) => {
                    const timeA = a.timestamp || a.id;
                    const timeB = b.timestamp || b.id;
                    return new Date(timeA) - new Date(timeB);
                });

                chronologicalLog.forEach(ticket => {
                    // Filtrar filas vacías o incompletas
                    if (!ticket.location || !ticket.product || !ticket.quantity) return;

                    // DEBUG INTERNO PARA VER QUÉ CLAVES LLEGAN
                    console.log("Fila PDF:", ticket);

                    // Aquí intentamos obtener la fecha de manera AGRESIVA
                    // Buscamos cualquier llave que se parezca a 'fecha', 'date', 'time'
                    const findDateValue = (obj) => {
                        // 1. Busqueda directa
                        const candidates = ['FECHA REGISTRO', 'fecha registro', 'Fecha Registro', 'FECHAREGISTRO', 'fechaRegistro', 'timestamp', 'date', 'Date', 'fecha', 'Fecha'];
                        for (const key of candidates) {
                            if (obj[key]) return obj[key];
                        }
                        // 2. Busqueda insensible a mayusculas
                        const keys = Object.keys(obj);
                        const match = keys.find(k => k.toUpperCase().includes('FECHA') || k.toUpperCase().includes('DATE') || k.toUpperCase().includes('TIME'));
                        if (match) return obj[match];
                        
                        // 3. Fallback a ID/Timestamp (ÚLTIMO RECURSO PERO SEGURO)
                        return obj.id || obj.timestamp;
                    };

                    const rawDate = findDateValue(ticket);
                    const dateStr = formatDate(rawDate);

                    const ticketData = [
                        ticket.location,
                        ticket.product,
                        ticket.quantity,
                        dateStr
                    ];
                    tableRows.push(ticketData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [22, 163, 74] } 
                });
                
                doc.save(`Auditoria_${new Date().toISOString().slice(0,10)}.pdf`);
            };


            const handleLocationClick = (locName) => {
                addLog(`Abriendo: ${locName}`);
                setSelectedLocation(locName);
                const existingEntry = auditLog.find(entry => entry.location === locName);
                if (existingEntry) {
                    setSelectedProduct(existingEntry.product);
                    setQuantity(existingEntry.quantity);
                } else {
                    setSelectedProduct('');
                    setQuantity('');
                }
                setIsModalOpen(true);
            };

            const handleSaveAudit = () => {
                if (!selectedLocation || !selectedProduct || !quantity) return alert("Faltan datos");
                
                // OPTIMISTIC UPDATE: Actualizar UI Inmediatamente
                // Add timestamp to payload for PDF
                const timestamp = Date.now();
                
                // CAMBIO REALIZADO: Enviamos 'timestamp' (número) en lugar de ISOString (texto)
                const payload = { 
                    id: timestamp, 
                    location: selectedLocation, 
                    product: selectedProduct, 
                    quantity: quantity, 
                    timestamp: timestamp // <--- Ahora se envía como número
                };
                
                // Agregar a la cola de guardado
                setSaveQueue(prev => [...prev, payload]);
                setPendingVerification(prev => [...prev, selectedLocation]);
                
                // Cerrar modal inmediatamente
                setIsModalOpen(false);
                setQuantity(''); setSelectedProduct('');
                
                addLog(`Guardado en cola: ${selectedLocation}`);
            };
            
            const handleQuantityKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleSaveAudit();
                }
            };

            const confirmDelete = async () => {
                // Agregar a cola de guardado como acción de borrado
                const payload = { location: selectedLocation, action: 'delete' };
                setSaveQueue(prev => [...prev, payload]);
                
                // Marcar como "borrando" visualmente (Rojo)
                setDeletingLocations(prev => [...prev, selectedLocation]);
                
                // Cerrar modal inmediatamente
                setIsDeleteConfirmOpen(false);
                setIsModalOpen(false);
                setQuantity(''); setSelectedProduct('');
                
                addLog(`Borrando en cola: ${selectedLocation}`);
            };
            
            // Función para ir al plano
            const goToMapAndFocus = (location) => {
                setActiveTab('map');
                setFocusTarget({ location, timestamp: Date.now() });
            };

            // Filtrado y Ordenamiento para Lista: Antiguo -> Nuevo (CORREGIDO AQUI)
            const auditMap = React.useMemo(() => {
                const map = new Map();
                auditLog.forEach(a => map.set(a.location, a));
                return map;
            }, [auditLog]);

            const sortedFilteredLocations = React.useMemo(() => {
                // 1. Filtrar
                const searchLower = searchTerm.toLowerCase();
                const filtered = locations.filter(loc => {
                    const auditData = auditMap.get(loc);
                    const matchesLoc = String(loc).toLowerCase().includes(searchLower);
                    const matchesProd = auditData && String(auditData.product).toLowerCase().includes(searchLower);
                    return matchesLoc || matchesProd;
                });
                
                // 2. Ordenar: Registrados (Antiguo->Nuevo) primero, luego pendientes
                return filtered.sort((a, b) => {
                    const entryA = auditMap.get(a);
                    const entryB = auditMap.get(b);
                    
                    // Ambos tienen datos: ordenar por ID (timestamp) ascendente (Antiguo -> Nuevo)
                    if (entryA && entryB) {
                        return entryA.id - entryB.id; 
                    }
                    // Si solo A tiene datos, va antes
                    if (entryA) return -1; 
                    // Si solo B tiene datos, va antes
                    if (entryB) return 1;  
                    // Ambos pendientes: orden alfabético
                    return a.localeCompare(b); 
                });
            }, [locations, auditMap, searchTerm]);

            // Filtrado para Historial (mantiene el orden de auditLog: Reciente->Antiguo)
            const filteredHistory = auditLog.filter(entry => {
                const s = historySearchTerm.toLowerCase();
                return String(entry.location).toLowerCase().includes(s) || 
                       String(entry.product).toLowerCase().includes(s) ||
                       String(entry.quantity).toLowerCase().includes(s);
            });

            const auditedLocNames = auditLog.map(l => l.location);
            const isCurrentLocAudited = auditedLocNames.includes(selectedLocation);
            
            // Productos únicos para búsqueda en mapa
            const uniqueProducts = [...new Set(auditLog.map(item => item.product))].sort();

            // --- DETECCIÓN DE COLUMNAS PARA DIAGNÓSTICO ---
            const detectedColumns = React.useMemo(() => {
                if (auditLog.length > 0) {
                    return Object.keys(auditLog[0]);
                }
                return [];
            }, [auditLog]);

            // --- Lógica de fecha robusta reutilizable ---
            const getEntryDate = (entry) => {
                const candidates = ['FECHA REGISTRO', 'fecha registro', 'Fecha Registro', 'FECHAREGISTRO', 'fechaRegistro', 'timestamp', 'date', 'Date', 'fecha', 'Fecha'];
                for (const key of candidates) {
                    if (entry[key]) return formatDate(entry[key]);
                }
                // Fallback a timestamp/id
                return formatDate(entry.id || entry.timestamp);
            };

            return (
                <div className="flex flex-col h-full bg-slate-50 text-slate-800 font-sans prevent-browser-zoom">
                    <header className="bg-blue-900 text-white p-4 shadow-md z-20 flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-3">
                            <div className={`w-3 h-3 rounded-full ${isOnline ? 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]' : 'bg-red-500 animate-pulse'}`} title={isOnline ? "Conectado" : "Desconectado"}></div>
                            <h1 className="text-xl font-bold tracking-tight">Auditoría Inventario</h1>
                        </div>
                        
                        {/* Botones Herramientas (Solo visibles con Ctrl+D) */}
                        {showTools && (
                            <div className="flex gap-2 items-center">
                                {/* Botón Debug */}
                                <div className="relative group w-8 h-8 flex items-center justify-center">
                                    <button 
                                        onClick={() => setIsDebugMode(!isDebugMode)} 
                                        className={`rounded-full transition-all duration-300 absolute
                                            ${isDebugMode ? 'w-[15px] h-[15px] bg-red-500' : 'w-2 h-2 bg-yellow-400'} 
                                            group-hover:w-[15px] group-hover:h-[15px] group-active:w-[20px] group-active:h-[20px]`}
                                        title="Modo Debug"
                                    >
                                        {/* Icono visible solo al hover o activo */}
                                        <div className="opacity-0 group-hover:opacity-100 group-active:opacity-100 flex items-center justify-center w-full h-full text-[10px] text-black font-bold">D</div>
                                    </button>
                                </div>

                                {/* Botón Refrescar */}
                                <div className="relative group w-8 h-8 flex items-center justify-center">
                                    <button 
                                        onClick={() => fetchSheetData(false)} 
                                        disabled={loading}
                                        className={`rounded-full transition-all duration-300 absolute
                                            ${loading ? 'w-[15px] h-[15px] bg-blue-300 animate-spin' : 'w-2 h-2 bg-green-400'}
                                            group-hover:w-[15px] group-hover:h-[15px] group-active:w-[20px] group-active:h-[20px]`}
                                        title="Refrescar Datos"
                                    >
                                         <div className="opacity-0 group-hover:opacity-100 group-active:opacity-100 flex items-center justify-center w-full h-full text-[8px] text-black"><Icons.RefreshCw /></div>
                                    </button>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="flex-1 overflow-hidden relative min-h-0">
                        <div className={`h-full w-full relative ${activeTab === 'map' ? 'block' : 'hidden'}`}>
                            <MapEditor 
                                onLocationClick={handleLocationClick} 
                                auditedLocations={auditedLocNames} 
                                locationsList={locations} 
                                isDebugMode={isDebugMode} 
                                addLog={addLog}
                                auditLog={auditLog}
                                focusTarget={focusTarget}
                                pendingLocations={pendingVerification}
                                deletingLocations={deletingLocations}
                            />
                        </div>

                        <div className={`h-full overflow-y-auto p-4 scroll-container touch-pan-y ${activeTab === 'places' ? 'block' : 'hidden'}`}>
                            <div className="relative mb-4 sticky top-0 z-10 flex gap-2">
                                <div className="relative flex-1">
                                    <div className="absolute top-3 left-3 text-slate-400"><Icons.Search /></div>
                                    <input type="text" placeholder="Buscar lugar o producto..." className="w-full pl-10 p-3 rounded-lg border shadow-sm" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                </div>
                                <button onClick={generatePDF} className="bg-red-600 text-white p-3 rounded-lg shadow hover:bg-red-700" title="Reportar PDF">
                                    <Icons.FileText />
                                </button>
                            </div>
                            <div className="space-y-2 pb-20">{sortedFilteredLocations.map((loc, idx) => {
                                const data = auditMap.get(loc);
                                return ( 
                                    <div key={idx} onClick={() => handleLocationClick(loc)} className={`p-4 rounded-lg border shadow-sm flex flex-col gap-1 cursor-pointer ${data ? 'bg-green-50 border-green-200' : 'bg-white'}`}>
                                        <div className="flex justify-between items-center">
                                            {/* NOMBRE + ICONO DE MAPA JUNTOS */}
                                            <div className="flex items-center gap-2">
                                                <span className="font-semibold">{loc}</span>
                                                <button onClick={(e) => { e.stopPropagation(); goToMapAndFocus(loc); }} className="text-blue-500 p-1 hover:bg-blue-50 rounded" title="Ver en mapa"><Icons.Target /></button>
                                            </div>
                                            {/* ICONO DE ESTADO A LA DERECHA */}
                                            {data ? <Icons.CheckCircle className="text-green-600 w-5 h-5" /> : <span className="text-xs text-slate-400">Pendiente</span>}
                                        </div>
                                        {data && (
                                            <div className="mt-1 border-t border-green-100 pt-2">
                                                <div className="text-sm text-slate-600 flex justify-between">
                                                    <span className="truncate flex-1 font-medium text-blue-800">{data.product}</span>
                                                    <span className="font-bold bg-green-200 px-2 rounded text-green-900">{data.quantity}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-400 text-right mt-1 font-mono">
                                                    {getEntryDate(data)}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}</div>
                        </div>

                        <div className={`h-full overflow-y-auto p-4 ${activeTab === 'history' ? 'block' : 'hidden'}`}>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold flex items-center gap-2"><Icons.ClipboardList className="text-blue-600" /> Historial</h2>
                            </div>
                            <div className="relative mb-4"><div className="absolute top-3 left-3 text-slate-400"><Icons.Search /></div><input type="text" placeholder="Filtrar historial..." className="w-full pl-10 p-2 rounded-lg border shadow-sm text-sm" value={historySearchTerm} onChange={(e) => setHistorySearchTerm(e.target.value)} /></div>
                            
                            <div className="space-y-3 pb-20">{filteredHistory.map((entry, idx) => ( 
                                <div key={idx} className="bg-white p-4 rounded-lg border-l-4 border-blue-600 shadow-sm flex flex-col gap-2">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <h3 className="font-bold text-blue-900">{entry.location}</h3>
                                                <button onClick={() => goToMapAndFocus(entry.location)} className="text-blue-400 hover:text-blue-600" title="Ver en mapa"><Icons.Target /></button>
                                            </div>
                                            <p className="text-sm font-medium">{entry.product}</p>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-xl font-bold">{entry.quantity}</span>
                                            <span className="text-xs text-slate-500">Sacos</span>
                                        </div>
                                    </div>
                                    <div className="text-xs text-slate-400 text-right border-t pt-1 font-mono">
                                        {getEntryDate(entry)}
                                    </div>
                                </div>
                            ))}</div>
                        </div>
                        
                        {isDebugMode && <DebugConsole logs={logs} />}
                    </main>

                    <nav className="bg-white border-t border-slate-200 flex justify-around p-2 pb-safe shadow-lg z-20 shrink-0">
                        <button onClick={() => setActiveTab('map')} className={`flex flex-col items-center p-2 rounded-lg w-20 ${activeTab === 'map' ? 'text-blue-600' : 'text-slate-400'}`}><Icons.Map /><span className="text-xs font-medium">Plano</span></button>
                        <button onClick={() => setActiveTab('places')} className={`flex flex-col items-center p-2 rounded-lg w-20 ${activeTab === 'places' ? 'text-blue-600' : 'text-slate-400'}`}><Icons.List /><span className="text-xs font-medium">Lista</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center p-2 rounded-lg w-20 ${activeTab === 'history' ? 'text-blue-600' : 'text-slate-400'}`}><Icons.ClipboardList /><span className="text-xs font-medium">Historial</span></button>
                    </nav>

                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={`Auditar: ${selectedLocation}`} align="top">
                        <div className="space-y-5">
                            <div>
                                <label className="block text-sm font-bold mb-2">Producto</label>
                                <AutocompleteInput 
                                    items={products} 
                                    value={selectedProduct} 
                                    onChange={setSelectedProduct} 
                                    placeholder="Buscar producto..." 
                                    onEnter={() => quantityInputRef.current && quantityInputRef.current.focus()}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-2">Cantidad</label>
                                <input 
                                    ref={quantityInputRef} 
                                    type="number" 
                                    className="w-full p-3 border rounded-lg text-center text-2xl" 
                                    value={quantity} 
                                    onChange={(e) => setQuantity(e.target.value)} 
                                    onKeyDown={handleQuantityKeyDown}
                                />
                            </div>
                            
                            <div className="flex gap-2 mt-4">
                                {isCurrentLocAudited && (
                                    <button 
                                        onClick={() => setIsDeleteConfirmOpen(true)} 
                                        className="bg-red-100 text-red-600 p-4 rounded-lg font-bold hover:bg-red-200 flex items-center justify-center border border-red-200"
                                        title="Borrar Datos"
                                    >
                                        <Icons.Trash />
                                    </button>
                                )}
                                <button onClick={handleSaveAudit} className="flex-1 bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg flex justify-center gap-2 items-center">
                                    <Icons.Save /> CONFIRMAR
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* NUEVA VENTANITA FLOTANTE DE CONFIRMACIÓN */}
                    <Modal isOpen={isDeleteConfirmOpen} onClose={() => setIsDeleteConfirmOpen(false)} title="Eliminar Registro" zIndex={200}>
                        <div className="text-center p-2">
                            <div className="flex justify-center mb-4 text-red-500">
                                <Icons.AlertTriangle width="48" height="48" />
                            </div>
                            <h3 className="font-bold text-lg text-gray-800 mb-2">¿Estás seguro?</h3>
                            <p className="text-sm text-gray-600 mb-6">
                                Se borrarán los datos del lugar <strong>{selectedLocation}</strong> permanentemente de la base de datos.
                            </p>
                            <div className="flex gap-3">
                                <button 
                                    onClick={() => setIsDeleteConfirmOpen(false)}
                                    className="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    onClick={confirmDelete}
                                    disabled={isSaving}
                                    className="flex-1 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 flex justify-center items-center gap-2"
                                >
                                    {isSaving ? 'Borrando...' : 'Sí, Eliminar'}
                                </button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InventoryAuditApp />);
    </script>
</body>
</html>
